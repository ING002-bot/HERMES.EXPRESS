<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HERMES - Panel Empleado</title>
    <link rel="stylesheet" href="css/panelempleado.css">
</head>
<body>
    <div class="contenedor">
        <!-- Barra lateral -->
        <nav class="barra-lateral">
            <div class="logo">
                <h2>HERMES EXPRESS LOGISTIC</h2>
            </div>
            
            <ul class="menu">
                <li><a href="#inicio" class="activo" onclick="mostrarSeccion('inicio')">
                    <span class="icono">üè†</span>Inicio
                </a></li>
                <li><a href="#mis-paquetes" onclick="mostrarSeccion('mis-paquetes')">
                    <span class="icono">üì¶</span>Mis Paquetes
                </a></li>
                <li><a href="#entregar" onclick="mostrarSeccion('entregar')">
                    <span class="icono">‚úÖ</span>Entregar
                </a></li>
                <li><a href="#ruta" onclick="mostrarSeccion('ruta')">
                    <span class="icono">üó∫Ô∏è</span>Mi Ruta
                </a></li>
                <li><a href="#perfil" onclick="mostrarSeccion('perfil')">
                    <span class="icono">üë§</span>Perfil
                </a></li>
            </ul>
            
            <div class="usuario-info">
                <div class="avatar">üë§</div>
                <div class="info">
                    <p id="nombreUsuario">Empleado</p>
                    <small>Empleado</small>
                </div>
                <button onclick="cerrarSesion()" class="btn-salir">üö™</button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="contenido-principal">
            <header class="cabecera">
                <h1 id="tituloSeccion">Panel de Empleado</h1>
                <div class="acciones">
                    <button class="btn btn-secundario" onclick="verNotificaciones()">üîî Notificaciones</button>
                </div>
            </header>

            <!-- Secci√≥n Inicio -->
            <section id="seccion-inicio" class="seccion activa">
                <div class="tarjetas-resumen">
                    <div class="tarjeta">
                        <div class="icono-tarjeta">üì¶</div>
                        <div class="info-tarjeta">
                            <h3 id="misPaquetes">0</h3>
                            <p>Mis Paquetes</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">üöõ</div>
                        <div class="info-tarjeta">
                            <h3 id="enRuta">0</h3>
                            <p>En Ruta</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">‚úÖ</div>
                        <div class="info-tarjeta">
                            <h3 id="entregadosHoy">0</h3>
                            <p>Entregados Hoy</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">‚è∞</div>
                        <div class="info-tarjeta">
                            <h3 id="pendientes">0</h3>
                            <p>Pendientes</p>
                        </div>
                    </div>
                </div>

                <div class="panel-trabajo">
                    <div class="tareas-hoy">
                        <h3>Tareas de Hoy</h3>
                        <div id="listaTareas" class="lista-tareas">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="estado-vehiculo">
                        <h3>Mi Veh√≠culo</h3>
                        <div id="infoVehiculo" class="info-vehiculo">
                            <!-- Se llena din√°micamente -->
                        </div>
                        <div class="acciones-vehiculo">
                            <button class="btn btn-primario" onclick="iniciarRuta()">Iniciar Ruta</button>
                            <button class="btn btn-secundario" onclick="reportarProblema()">Reportar Problema</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Mis Paquetes -->
            <section id="seccion-mis-paquetes" class="seccion">
                <div class="filtros">
                    <input type="text" id="buscarMiPaquete" placeholder="Buscar por c√≥digo o destinatario...">
                    <select id="filtroMiEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="en_transito">En Tr√°nsito</option>
                        <option value="entregado">Entregado</option>
                    </select>
                </div>
                
                <div class="tabla-container">
                    <table id="tablaMisPaquetes">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Destinatario</th>
                                <th>Direcci√≥n</th>
                                <th>Estado</th>
                                <th>Peso</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaMisPaquetes">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Secci√≥n Entregar -->
            <section id="seccion-entregar" class="seccion">
                <div class="panel-entrega">
                    <h3>Confirmar Entrega</h3>
                    <form id="formEntrega">
                        <div class="form-grupo">
                            <label>C√≥digo del Paquete:</label>
                            <input type="text" id="codigoEntrega" placeholder="Escanear o escribir c√≥digo" required>
                            <button type="button" class="btn-escanear" onclick="escanearCodigo()">üì∑</button>
                        </div>
                        <div class="form-grupo">
                            <label>Nombre del Receptor:</label>
                            <input type="text" id="nombreReceptor" required>
                        </div>
                        <div class="form-grupo">
                            <label>Documento del Receptor:</label>
                            <input type="text" id="documentoReceptor" required>
                        </div>
                        <div class="form-grupo">
                            <label>Observaciones:</label>
                            <textarea id="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        <div class="form-grupo">
                            <label>Foto de Entrega:</label>
                            <input type="file" id="fotoEntrega" accept="image/*" capture="camera">
                        </div>
                        <div class="form-acciones">
                            <button type="submit" class="btn btn-primario">Confirmar Entrega</button>
                            <button type="button" class="btn btn-secundario" onclick="limpiarFormEntrega()">Limpiar</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Secci√≥n Mi Ruta -->
            <section id="seccion-ruta" class="seccion">
                <div class="info-ruta">
                    <h3>Ruta del D√≠a</h3>
                    <div id="detallesRuta" class="detalles-ruta">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
                
                <div class="mapa-ruta">
                    <h3>Mapa de Entregas</h3>
                    <div id="mapaContainer" class="mapa-container">
                        <div id="map" style="height: 100%; width: 100%;"></div>
                        <div id="info-panel">
                            <button id="iniciarRutaBtn" class="btn btn-primario">Iniciar Ruta</button>
                            <div id="distancia"></div>
                            <div id="tiempo"></div>
                        </div>
                    </div>
                </div>
                
                <div class="lista-entregas">
                    <h3>Entregas Programadas</h3>
                    <div id="listaEntregas" class="entregas-programadas">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Perfil -->
            <section id="seccion-perfil" class="seccion">
                <div class="perfil-empleado">
                    <h3>Mi Perfil</h3>
                    <form id="formPerfil">
                        <div class="form-grupo">
                            <label>Nombre:</label>
                            <input type="text" id="perfilNombre" readonly>
                        </div>
                        <div class="form-grupo">
                            <label>Usuario:</label>
                            <input type="text" id="perfilUsuario" readonly>
                        </div>
                        <div class="form-grupo">
                            <label>Email:</label>
                            <input type="email" id="perfilEmail" readonly>
                        </div>
                        <div class="form-grupo">
                            <p class="nota-perfil">* Los datos del perfil son gestionados por el sistema</p>
                        </div>
                        <!-- Bot√≥n de actualizaci√≥n de perfil eliminado -->
                    </form>
                </div>
                
                <div class="estadisticas-empleado">
                    <h3>Mis Estad√≠sticas</h3>
                    <div id="estadisticasContainer" class="estadisticas-container">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Google Maps API -->
    <script>
        // Variables globales para el mapa
        let map;
        let directionsService;
        let directionsRenderer;
        let watchId;
        let currentPosition = null;
        let deliveryMarkers = [];
        let currentLocationMarker = null;
        let routePolyline = null;
        window.mapInitialized = false;

        // Funci√≥n para inicializar el mapa
        function initMap() {
            if (window.mapInitialized) return;
            
            try {
                // Configuraci√≥n inicial del mapa centrado en Lima, Per√∫
                const lima = { lat: -12.0464, lng: -77.0428 };
                
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: lima,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
                
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true
                });
                
                window.mapInitialized = true;
                console.log('Mapa inicializado correctamente');
                
                // Disparar evento personalizado cuando el mapa est√° listo
                const event = new Event('mapInitialized');
                window.dispatchEvent(event);
                
            } catch (error) {
                console.error('Error al inicializar el mapa:', error);
            }
        }
        
        // Cargar la API de Google Maps de forma as√≠ncrona
        (function() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAhKq8glWDGij47iJZy2_RB8jan9D1V-Sk&libraries=geometry,places&callback=initMap&loading=async';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // Cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                // Limpiar el almacenamiento local si es necesario
                if (typeof(Storage) !== 'undefined') {
                    localStorage.removeItem('sesion_activa');
                    sessionStorage.clear();
                }
                
                // Realizar la petici√≥n de cierre de sesi√≥n
                fetch('php/cerrar_sesion.php', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                    }
                })
                .then(response => {
                    // Asegurarse de que la redirecci√≥n ocurra incluso si hay un error en la respuesta
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    // Forzar recarga sin cach√©
                    window.location.replace('login.html');
                })
                .catch(error => {
                    console.error('Error al cerrar sesi√≥n:', error);
                    // Redirigir de todas formas
                    window.location.replace('login.html');
                });
            }
        }

        // Prevenir navegaci√≥n hacia atr√°s despu√©s de cerrar sesi√≥n
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function(event) {
            window.history.pushState(null, null, window.location.href);
        };

        // Verificar sesi√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            fetch('php/verificar_sesion.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.sesion_activa) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Verificar que sea empleado
                    if (data.usuario.tipo !== 'empleado') {
                        alert('Acceso denegado. Solo empleados pueden acceder a este panel.');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Actualizar informaci√≥n del usuario
                    document.getElementById('nombreUsuario').textContent = data.usuario.nombre;
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = 'login.html';
                });
        });
    </script>
    <script src="js/panelempleado.js"></script>
</body>
</html>