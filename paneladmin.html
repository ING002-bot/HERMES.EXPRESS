<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Panel de Administraci√≥n HERMES EXPRESS LOGISTIC">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Preload de fuentes cr√≠ticas -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Precargar CSS cr√≠tico -->
    <link rel="stylesheet" href="css/paneladmin.css">
    <link rel="stylesheet" href="css/paneladmin-responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>HERMES - Panel Administrador</title>
</head>
<body>
    <div class="contenedor">
        <!-- Bot√≥n de men√∫ m√≥vil -->
        <button class="menu-movil" id="btnMenuMovil" aria-label="Men√∫">
            <i class="fas fa-bars"></i>
        </button>
        
        <nav class="barra-lateral" id="barraLateral">
            <div class="logo">
                <h2>HERMES EXPRESS LOGISTIC</h2>
            </div>
            
            <ul class="menu">
                <li><a href="javascript:void(0)" class="activo" onclick="mostrarSeccion('dashboard', this)">
                    <span class="icono">üìä</span>Dashboard
                </a></li>
                <li><a href="javascript:void(0)" onclick="mostrarSeccion('paquetes', this)">
                    <span class="icono">üì¶</span>Paquetes
                </a></li>
                <li><a href="javascript:void(0)" onclick="mostrarSeccion('vehiculos', this)">
                    <span class="icono">üöõ</span>Veh√≠culos
                </a></li>
                <li><a href="javascript:void(0)" onclick="mostrarSeccion('rutas', this)">
                    <span class="icono">üó∫Ô∏è</span>Rutas
                </a></li>
                <li><a href="javascript:void(0)" onclick="mostrarSeccion('pagos', this)">
                    <span class="icono">üí∞</span>Pagos Empleados
                </a></li>
                <li>
                    <a href="#" onclick="mostrarSeccion('usuarios', this)" class="menu-item">
                        <i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios
                    </a>
                </li>
            </ul>
            
            <div class="usuario-info">
                <div class="avatar">üë§</div>
                <div class="info">
                    <p id="nombreUsuario">Administrador</p>
                    <small>Admin</small>
                </div>
                <button onclick="cerrarSesion()" class="btn-salir">üö™</button>
            </div>
        </nav>

        <main class="contenido-principal">
            <header class="cabecera">
                <h1 id="tituloSeccion">Panel de Administraci√≥n</h1>
                <div class="acciones">
                    <!-- Bot√≥n de actualizaci√≥n eliminado -->
                </div>
            </header>

            <section id="seccion-dashboard" class="seccion activa">
                <div class="metricas-principales">
                    <div class="tarjeta-metrica">
                        <div class="icono-metrica">üì¶</div>
                        <div class="info-metrica">
                            <h3 id="totalPaquetes">0</h3>
                            <p>Total Paquetes</p>
                        </div>
                    </div>
                    <div class="tarjeta-metrica">
                        <div class="icono-metrica">üí∞</div>
                        <div class="info-metrica">
                            <h3 id="ingresosMes">$0</h3>
                            <p>Ingresos del Mes</p>
                        </div>
                    </div>
                    <div class="tarjeta-metrica">
                        <div class="icono-metrica">üöõ</div>
                        <div class="info-metrica">
                            <h3 id="vehiculosOperativos">0</h3>
                            <p>Veh√≠culos Operativos</p>
                        </div>
                    </div>
                </div>

                <div class="graficos-admin">
                    <div class="grafico-ventas">
                        <h3>Ingresos por Mes</h3>
                        <canvas id="graficoVentas" width="600" height="300"></canvas>
                    </div>
                    <div class="actividad-reciente">
                        <h3>Actividad Reciente</h3>
                        <div id="listaActividad" class="lista-actividad">
                        </div>
                    </div>
                </div>
            </section>

            <section id="seccion-paquetes" class="seccion">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="filtros" style="margin-right: auto;">
                        <input type="text" id="buscarPaquete" placeholder="Buscar por c√≥digo o destinatario...">
                        <select id="filtroEstado">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_transito">En Tr√°nsito</option>
                            <option value="entregado">Entregado</option>
                            <option value="devuelto">Devuelto</option>
                        </select>
                    </div>
                    <div class="d-flex">
                        <button class="btn btn-exportar me-2" onclick="exportarAPDF('paquetes')">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </button>
                        <button class="btn btn-exportar me-2" onclick="exportarAExcel('paquetes')">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </button>
                        <button id="btnEjecutarSelenium" class="btn btn-primario" onclick="ejecutarSelenium()">
                            <i class="fas fa-play me-1"></i> Extracci√≥n de datos
                        </button>
                        <button id="btnImportarDownloads" class="btn btn-exito ms-2" onclick="importarDesdeDownloadsYMostrar()" title="Importar TODOS los Excel de downloads/ a la BD y mostrarlos">
                            <i class="fas fa-database me-1"></i> Mostrar datos
                        </button>
                    </div>
                </div>
                <div class="tabla-container">
                    <table id="tablaPaquetes">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Remitente</th>
                                <th>Destinatario</th>
                                <th>Estado</th>
                                <th>Peso</th>
                                <th>Precio</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaPaquetes"></tbody>
                    </table>
                </div>
            </section>

            <section id="seccion-vehiculos" class="seccion">
                <div class="controles-vehiculos d-flex justify-content-end align-items-center mb-3">
                    <button class="btn btn-primario me-2" onclick="nuevoVehiculo()">+ Nuevo Veh√≠culo</button>
                    <button class="btn btn-exportar" onclick="exportarAExcel('vehiculos')">
                        <i class="fas fa-file-excel me-1"></i> Excel
                    </button>
                </div>
                
                <div class="tabla-container">
                    <table id="tablaVehiculos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Placa</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Capacidad</th>
                                <th>Estado</th>
                                <th>Empleado Asignado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaVehiculos">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="seccion-rutas" class="seccion">
                <div class="controles-rutas d-flex justify-content-end align-items-center mb-3">
                    <button class="btn btn-primario me-2" onclick="nuevaRuta()">+ Nueva Ruta</button>
                </div>
                
                <div class="tabla-container">
                    <table id="tablaRutas">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Origen</th>
                                <th>Destino</th>
                                <th>Distancia (km)</th>
                                <th>Tiempo Estimado (min)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaRutas">
                        </tbody>
                    </table>
                </div>
            </section>


            <section id="seccion-pagos" class="seccion">
                <div class="seccion-header">
                    <h2>Gesti√≥n de Pagos a Empleados</h2>
                    <div class="acciones">
                        <button class="btn btn-primario" onclick="calcularPagos()">üßÆ Calcular Pagos</button>
                        <button class="btn btn-secundario" onclick="configurarTarifas()">‚öôÔ∏è Configurar Tarifas</button>
                        <button class="btn btn-exito" onclick="exportarPagos()">üìÑ Exportar</button>
                    </div>
                </div>

                <!-- Filtros de per√≠odo -->
                <div class="filtros-pago">
                    <div class="form-group">
                        <label>Per√≠odo Inicio</label>
                        <input type="date" id="fechaInicioPago" value="">
                    </div>
                    <div class="form-group">
                        <label>Per√≠odo Fin</label>
                        <input type="date" id="fechaFinPago" value="">
                    </div>
                    <div class="form-group">
                        <label>Empleado</label>
                        <select id="filtroEmpleadoPago">
                            <option value="">Todos los empleados</option>
                        </select>
                    </div>
                    <button class="btn btn-primario" onclick="filtrarPagos()">üîç Filtrar</button>
                </div>

                <!-- Tarifas por tipo de ruta -->
                <div class="tarifas-container">
                    <h3>Tarifas por Tipo de Ruta</h3>
                    <div class="tarifas-grid" id="tarifasGrid">
                        <!-- Se llenan din√°micamente -->
                    </div>
                </div>

                <!-- Resumen de pagos -->
                <div class="pagos-resumen">
                    <div class="pago-card">
                        <h4>Total a Pagar</h4>
                        <p class="monto-total" id="totalPagar">$0</p>
                    </div>
                    <div class="pago-card">
                        <h4>Empleados</h4>
                        <p class="numero" id="totalEmpleados">0</p>
                    </div>
                    <div class="pago-card">
                        <h4>Paquetes Entregados</h4>
                        <p class="numero" id="totalEntregados">0</p>
                    </div>
                    <div class="pago-card">
                        <h4>Paquetes Devueltos</h4>
                        <p class="numero" id="totalDevueltos">0</p>
                    </div>
                </div>

                <!-- Lista de pagos por empleado -->
                <div class="pagos-empleados">
                    <h3>Pagos por Empleado</h3>
                    <div class="tabla-container">
                        <table class="tabla">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Entregados</th>
                                    <th>Devueltos</th>
                                    <th>Urbano</th>
                                    <th>Distrital</th>
                                    <th>Interprovincial</th>
                                    <th>Interurbano</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTablaPagos">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n de Gesti√≥n de Usuarios -->
            <section id="seccion-usuarios" class="seccion">
                <div class="controles-usuarios d-flex justify-content-end align-items-center mb-3">
                    <button class="btn btn-primario me-2" onclick="mostrarFormularioUsuario('nuevo')">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </button>
                    <button class="btn btn-exportar me-2" onclick="exportarAPDF('usuarios')">
                        <i class="fas fa-file-pdf me-1"></i> PDF
                    </button>
                    <button class="btn btn-exportar me-2" onclick="exportarAExcel('usuarios')">
                        <i class="fas fa-file-excel me-1"></i> Excel
                    </button>
                </div>
                <div class="seccion-header">
                    <h2>Gesti√≥n de Usuarios</h2>
                    <div class="acciones">
                        <!-- Bot√≥n de actualizaci√≥n eliminado -->
                    </div>
                </div>

                <div id="alertContainer"></div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="usuariosTable" class="table table-striped table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargar√°n din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Modal para Crear/Editar Usuario -->
            <div class="modal fade" id="usuarioModal" tabindex="-1" aria-labelledby="usuarioModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="usuarioModalLabel">Nuevo Usuario</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <form id="usuarioForm" data-action="crear">
                            <input type="hidden" id="usuario_id" name="usuario_id">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="usuario" class="form-label">Nombre de Usuario</label>
                                    <input type="text" class="form-control" id="usuario" name="usuario" required>
                                </div>
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="tipo" class="form-label">Tipo de Usuario</label>
                                    <select class="form-select" id="tipo" name="tipo" required>
                                        <option value="admin">Administrador</option>
                                        <option value="asistente">Asistente</option>
                                        <option value="empleado">Empleado</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="clave" class="form-label">Contrase√±a</label>
                                    <input type="password" class="form-control" id="clave" name="clave" required>
                                    <small class="text-muted">M√≠nimo 6 caracteres</small>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="activo" name="activo" checked>
                                    <label class="form-check-label" for="activo">Usuario Activo</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="modalTarifas" class="modal">
                <div class="modal-contenido">
                    <div class="modal-header">
                        <h3>Configurar Tarifas por Ruta</h3>
                        <span class="cerrar" onclick="cerrarModal('modalTarifas')">&times;</span>
                    </div>
                    <form id="formTarifas">
                        <div class="form-group">
                            <label>Tipo de Ruta</label>
                            <select id="tipoRutaTarifa" required>
                                <option value="urbano">Urbano</option>
                                <option value="distrital">Distrital</option>
                                <option value="interprovincial">Interprovincial</option>
                                <option value="interurbano">Interurbano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tarifa Base ($)</label>
                            <input type="number" id="tarifaBase" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Tarifa por Kg ($)</label>
                            <input type="number" id="tarifaPorKg" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Comisi√≥n Empleado (%)</label>
                            <input type="number" id="comisionEmpleado" step="0.01" min="0" max="100" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="descripcionTarifa" rows="3"></textarea>
                        </div>
                        <div class="modal-acciones">
                            <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalTarifas')">Cancelar</button>
                            <button type="submit" class="btn btn-primario">Guardar Tarifa</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="modalEditarCantidades" class="modal">
                <div class="modal-contenido">
                    <div class="modal-header">
                        <h3>Editar Cantidades por Zona</h3>
                        <span class="cerrar" onclick="cerrarModal('modalEditarCantidades')">&times;</span>
                    </div>
                    <div class="empleado-info">
                        <h4 id="empleadoEditando">Empleado: </h4>
                        <p>Per√≠odo: <span id="periodoEditando"></span></p>
                    </div>
                    
                    <div class="zonas-grid">
                        <div class="zona-card">
                            <h5>üèôÔ∏è Urbano</h5>
                            <div class="cantidad-controls">
                                <label>Entregados:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('urbano', 'entregados', -1)">-</button>
                                    <input type="number" id="urbano-entregados" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('urbano', 'entregados', 1)">+</button>
                                </div>
                            </div>
                            <div class="cantidad-controls">
                                <label>Devueltos:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('urbano', 'devueltos', -1)">-</button>
                                    <input type="number" id="urbano-devueltos" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('urbano', 'devueltos', 1)">+</button>
                                </div>
                            </div>
                            <div class="zona-total">Total: $<span id="urbano-total">0</span></div>
                        </div>

                        <div class="zona-card">
                            <h5>üèòÔ∏è Distrital</h5>
                            <div class="cantidad-controls">
                                <label>Entregados:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('distrital', 'entregados', -1)">-</button>
                                    <input type="number" id="distrital-entregados" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('distrital', 'entregados', 1)">+</button>
                                </div>
                            </div>
                            <div class="cantidad-controls">
                                <label>Devueltos:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('distrital', 'devueltos', -1)">-</button>
                                    <input type="number" id="distrital-devueltos" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('distrital', 'devueltos', 1)">+</button>
                                </div>
                            </div>
                            <div class="zona-total">Total: $<span id="distrital-total">0</span></div>
                        </div>

                        <div class="zona-card">
                            <h5>üåç Interprovincial</h5>
                            <div class="cantidad-controls">
                                <label>Entregados:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('interprovincial', 'entregados', -1)">-</button>
                                    <input type="number" id="interprovincial-entregados" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('interprovincial', 'entregados', 1)">+</button>
                                </div>
                            </div>
                            <div class="cantidad-controls">
                                <label>Devueltos:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('interprovincial', 'devueltos', -1)">-</button>
                                    <input type="number" id="interprovincial-devueltos" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('interprovincial', 'devueltos', 1)">+</button>
                                </div>
                            </div>
                            <div class="zona-total">Total: $<span id="interprovincial-total">0</span></div>
                        </div>

                        <div class="zona-card">
                            <h5>üöó Interurbano</h5>
                            <div class="cantidad-controls">
                                <label>Entregados:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('interurbano', 'entregados', -1)">-</button>
                                    <input type="number" id="interurbano-entregados" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('interurbano', 'entregados', 1)">+</button>
                                </div>
                            </div>
                            <div class="cantidad-controls">
                                <label>Devueltos:</label>
                                <div class="input-group">
                                    <button type="button" onclick="ajustarCantidad('interurbano', 'devueltos', -1)">-</button>
                                    <input type="number" id="interurbano-devueltos" min="0" value="0">
                                    <button type="button" onclick="ajustarCantidad('interurbano', 'devueltos', 1)">+</button>
                                </div>
                            </div>
                            <div class="zona-total">Total: $<span id="interurbano-total">0</span></div>
                        </div>
                    </div>

                    <div class="resumen-edicion">
                        <div class="total-general">
                            <h4>Total General: $<span id="totalGeneralEdicion">0</span></h4>
                        </div>
                    </div>

                    <div class="modal-acciones">
                        <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalEditarCantidades')">Cancelar</button>
                        <button type="button" class="btn btn-primario" onclick="guardarCantidades()">Guardar Cambios</button>
                    </div>
                </div>
            </div>

            <div id="modalVehiculo" class="modal">
                <div class="modal-contenido">
                    <span class="cerrar" onclick="cerrarModal('modalVehiculo')">&times;</span>
                    <h2>Nuevo Veh√≠culo</h2>
                    <form id="formVehiculo" onsubmit="guardarVehiculo(event)">
                        <div class="form-grupo">
                            <label>Placa:</label>
                            <input type="text" id="placaVehiculo" required>
                        </div>
                        <div class="form-grupo">
                            <label>Marca:</label>
                            <input type="text" id="marcaVehiculo" required>
                        </div>
                        <div class="form-grupo">
                            <label>Modelo:</label>
                            <input type="text" id="modeloVehiculo" required>
                        </div>
                        <div class="form-grupo">
                            <label>Capacidad (kg):</label>
                            <input type="number" id="capacidadVehiculo" step="0.1" required>
                        </div>
                        <div class="form-grupo">
                            <label>Estado:</label>
                            <select id="estadoVehiculo" required>
                                <option value="disponible">Disponible</option>
                                <option value="en_uso">En Uso</option>
                                <option value="mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                        <div class="form-acciones">
                            <button type="submit" class="btn btn-primario">Guardar</button>
                            <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalVehiculo')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="modalRuta" class="modal">
                <div class="modal-contenido">
                    <span class="cerrar" onclick="cerrarModal('modalRuta')">&times;</span>
                    <h2>Nueva Ruta</h2>
                    <form id="formRuta" onsubmit="guardarRuta(event)">
                        <div class="form-grupo">
                            <label>Nombre de la Ruta:</label>
                            <input type="text" id="nombreRuta" required>
                        </div>
                        <div class="form-grupo">
                            <label>Origen:</label>
                            <input type="text" id="origenRuta" required>
                        </div>
                        <div class="form-grupo">
                            <label>Destino:</label>
                            <input type="text" id="destinoRuta" required>
                        </div>
                        <div class="form-grupo">
                            <label>Distancia (km):</label>
                            <input type="number" id="distanciaRuta" step="0.1" required>
                        </div>
                        <div class="form-grupo">
                            <label>Tiempo Estimado (minutos):</label>
                            <input type="number" id="tiempoRuta" required>
                        </div>
                        <div class="form-acciones">
                            <button type="submit" class="btn btn-primario">Guardar</button>
                            <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalRuta')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal para Empleado -->
            <div class="modal fade" id="modalEmpleado" tabindex="-1" aria-labelledby="modalEmpleadoLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalEmpleadoLabel">Nuevo Empleado</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formEmpleado" onsubmit="guardarEmpleado(event)">
                        <div class="form-grupo">
                            <label>Nombre:</label>
                            <input type="text" id="nombreEmpleado" required>
                        </div>
                        <div class="form-grupo">
                            <label>Usuario:</label>
                            <input type="text" id="usuarioEmpleado" required>
                        </div>
                        <div class="form-grupo">
                            <label>Email:</label>
                            <input type="email" id="emailEmpleado" required>
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Tipo:</label>
                            <select id="tipoEmpleado" class="form-select" required>
                                <option value="empleado">Empleado</option>
                                <option value="asistente">Asistente</option>
                            </select>
                        </div>
                        <div class="form-grupo">
                            <label class="form-label">Contrase√±a:</label>
                            <input type="password" id="claveEmpleado" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        </main>
    </div>

    <!-- Scripts en el orden correcto -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Verificar que todas las dependencias est√©n cargadas
        if (typeof jQuery == 'undefined') {
            console.error('Error: jQuery no se ha cargado correctamente');
        } else {
            console.log('jQuery versi√≥n:', $.fn.jquery);
        }
        
        if (typeof bootstrap === 'undefined') {
            console.error('Error: Bootstrap no se ha cargado correctamente');
        } else {
            console.log('Bootstrap cargado correctamente');
        }
        
        // Funci√≥n para cerrar sesi√≥n - definida globalmente
        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                // Limpiar el almacenamiento local si es necesario
                if (typeof(Storage) !== 'undefined') {
                    localStorage.removeItem('sesion_activa');
                    sessionStorage.clear();
                }
                
                // Realizar la petici√≥n de cierre de sesi√≥n
                fetch('php/cerrar_sesion.php', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                    }
                })
                .then(response => {
                    // Asegurarse de que la redirecci√≥n ocurra incluso si hay un error en la respuesta
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    // Forzar recarga sin cach√©
                    window.location.replace('login.html');
                })
                .catch(error => {
                    console.error('Error al cerrar sesi√≥n:', error);
                    // Redirigir de todas formas
                    window.location.replace('login.html');
                });
            }
        }

        // Funci√≥n para abrir modal
        function abrirModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Funci√≥n para cerrar modal
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Limpiar formularios
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        // Funci√≥n para actualizar p√°gina
        function actualizar() {
            location.reload();
        }
        
        // Funci√≥n para mostrar el formulario de usuario
        function mostrarFormularioUsuario(accion, id = '') {
            // Verificar si Bootstrap est√° cargado
            if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
                console.error('Bootstrap no est√° cargado correctamente');
                alert('Error: No se pudo cargar el formulario. Por favor, recarga la p√°gina.');
                return;
            }
            
            const modalElement = document.getElementById('usuarioModal');
            if (!modalElement) {
                console.error('No se encontr√≥ el elemento del modal');
                return;
            }
            
            const titulo = document.getElementById('usuarioModalLabel');
            const form = document.getElementById('usuarioForm');
            
            if (!titulo || !form) {
                console.error('No se encontraron los elementos necesarios del formulario');
                return;
            }
            
            try {
                const modal = new bootstrap.Modal(modalElement);
                
                if (accion === 'nuevo') {
                    titulo.textContent = 'Nuevo Usuario';
                    form.reset();
                    // Establecer valores por defecto
                    const usuarioId = document.getElementById('usuario_id');
                    const tipo = document.getElementById('tipo');
                    const activo = document.getElementById('activo');
                    
                    if (usuarioId) usuarioId.value = '';
                    if (tipo) tipo.value = 'empleado';
                    if (activo) activo.checked = true;
                } else if (accion === 'editar') {
                    titulo.textContent = 'Editar Usuario';
                    // Cargar datos del usuario con el ID proporcionado
                    console.log('Editando usuario con ID:', id);
                }
                
                modal.show();
            } catch (error) {
                console.error('Error al mostrar el formulario:', error);
                alert('Ocurri√≥ un error al intentar abrir el formulario');
            }
        }
        
        // Funci√≥n para nuevos empleados, veh√≠culos, rutas
        function nuevoEmpleado() {
            // Resetear el formulario
            const form = document.getElementById('formEmpleado');
            form.reset();
            
            // Cambiar el t√≠tulo del modal
            document.getElementById('modalEmpleadoLabel').textContent = 'Nuevo Empleado';
            
            // Establecer la acci√≥n como 'crear'
            form.setAttribute('data-accion', 'crear');
            
            // Mostrar el modal usando Bootstrap 5
            const modal = new bootstrap.Modal(document.getElementById('modalEmpleado'));
            modal.show();
        }
        
        function nuevoVehiculo() {
            abrirModal('modalVehiculo');
        }
        
        function nuevaRuta() {
            abrirModal('modalRuta');
        }
        
        // Funciones para guardar nuevos registros
        function guardarVehiculo() {
            const formData = new FormData();
            formData.append('accion', 'crear_vehiculo');
            formData.append('placa', document.getElementById('placa').value);
            formData.append('marca', document.getElementById('marca').value);
            formData.append('modelo', document.getElementById('modelo').value);
            formData.append('anio', document.getElementById('anio').value);
            formData.append('capacidad', document.getElementById('capacidad').value);
            formData.append('estado', document.getElementById('estado').value);
            
            const empleadoId = document.getElementById('empleadoId').value;
            if (empleadoId) {
                formData.append('empleado_id', empleadoId);
            }
            
            fetch('php/admin.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    alert('Veh√≠culo guardado exitosamente');
                    document.getElementById('formVehiculo').reset();
                    cerrarModal('modalVehiculo');
                    cargarVehiculos();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar veh√≠culo. Verifica la consola para m√°s detalles.');
            });
        }
        
        function guardarRuta(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('accion', 'nueva_ruta');
            formData.append('nombre', document.getElementById('nombreRuta').value);
            formData.append('origen', document.getElementById('origenRuta').value);
            formData.append('destino', document.getElementById('destinoRuta').value);
            formData.append('distancia', document.getElementById('distanciaRuta').value);
            formData.append('tiempo_estimado', document.getElementById('tiempoRuta').value);
            
            fetch('php/admin.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    alert('Ruta creada exitosamente');
                    cerrarModal('modalRuta');
                    cargarRutas();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear ruta');
            });
        }
        
        function guardarEmpleado(event) {
            event.preventDefault();
            
            // Obtener referencias a los elementos del formulario
            const form = document.getElementById('formEmpleado');
            const formData = new FormData(form);
            formData.append('accion', 'nuevo_empleado');
            
            // Validar campos obligatorios
            const requiredFields = ['nombre', 'usuario', 'email', 'clave', 'tipo'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const value = formData.get(field);
                if (!value || value.trim() === '') {
                    alert(`El campo ${field} es obligatorio`);
                    isValid = false;
                    return;
                }
            });
            
            if (!isValid) return;
            
            // Mostrar indicador de carga
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar datos al servidor
            fetch('php/admin.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.exito) {
                    // Mostrar mensaje de √©xito
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success';
                    successAlert.role = 'alert';
                    successAlert.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        ${data.mensaje || 'Empleado creado exitosamente'}
                    `;
                    
                    // Insertar el mensaje antes del formulario
                    form.parentNode.insertBefore(successAlert, form);
                    
                    // Limpiar el formulario
                    form.reset();
                    
                    // Cerrar el modal despu√©s de 1.5 segundos
                    setTimeout(() => {
                        cerrarModal('modalEmpleado');
                        cargarEmpleados();
                        
                        // Eliminar el mensaje de √©xito despu√©s de cerrar el modal
                        if (successAlert.parentNode) {
                            successAlert.parentNode.removeChild(successAlert);
                        }
                    }, 1500);
                    
                } else {
                    // Mostrar mensaje de error
                    throw new Error(data.mensaje || 'Error desconocido al crear empleado');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Mostrar mensaje de error al usuario
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger';
                errorAlert.role = 'alert';
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    ${error.message || 'Error al crear empleado. Por favor, int√©ntalo de nuevo.'}
                `;
                
                // Insertar el mensaje antes del formulario
                form.parentNode.insertBefore(errorAlert, form);
                
                // Eliminar el mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    if (errorAlert.parentNode) {
                        errorAlert.parentNode.removeChild(errorAlert);
                    }
                }, 5000);
            })
            .finally(() => {
                // Restaurar el bot√≥n
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        }
        
        function generarReporte() {
            const tipo = document.getElementById('tipoReporte').value;
            const fechaInicio = document.getElementById('reporteFechaInicio').value;
            const fechaFin = document.getElementById('reporteFechaFin').value;
            const formato = document.getElementById('formatoDescarga').value;
            
            const formData = new FormData();
            formData.append('accion', 'generar_reporte');
            formData.append('tipo', tipo);
            formData.append('fecha_inicio', fechaInicio);
            formData.append('fecha_fin', fechaFin);
            formData.append('formato', formato);
            
            if (formato === 'ver') {
                // Mostrar en pantalla
                fetch('php/admin.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exito) {
                        mostrarReporte(data.datos, tipo);
                    } else {
                        alert('Error al generar reporte: ' + data.mensaje);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al generar reporte');
                });
            } else {
                // Descargar archivo
                const url = 'php/admin.php?' + new URLSearchParams({
                    accion: 'generar_reporte',
                    tipo: tipo,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin,
                    formato: formato
                });
                
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = url;
                link.download = `reporte_${tipo}_${new Date().toISOString().split('T')[0]}.${formato === 'excel' ? 'xlsx' : 'pdf'}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function mostrarReporte(datos, tipo) {
            const contenedor = document.getElementById('contenidoReporte');
            let html = `<h4>Reporte de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h4>`;
            
            if (datos.length === 0) {
                html += '<p>No hay datos para mostrar en el per√≠odo seleccionado.</p>';
            } else {
                html += '<table class="tabla-reporte"><thead><tr>';
                
                // Headers seg√∫n tipo de reporte
                if (tipo === 'paquetes') {
                    html += '<th>C√≥digo</th><th>Remitente</th><th>Destinatario</th><th>Estado</th><th>Precio</th><th>Fecha</th>';
                } else if (tipo === 'ventas') {
                    html += '<th>Fecha</th><th>Total Paquetes</th><th>Ingresos</th>';
                } else if (tipo === 'empleados') {
                    html += '<th>Nombre</th><th>Usuario</th><th>Tipo</th><th>Estado</th><th>Fecha Registro</th>';
                } else if (tipo === 'vehiculos') {
                    html += '<th>Placa</th><th>Marca</th><th>Modelo</th><th>Estado</th><th>Empleado</th>';
                }
                
                html += '</tr></thead><tbody>';
                
                datos.forEach(item => {
                    html += '<tr>';
                    if (tipo === 'paquetes') {
                        html += `<td>${item.codigo}</td><td>${item.remitente}</td><td>${item.destinatario}</td><td>${item.estado}</td><td>$${item.precio}</td><td>${new Date(item.fecha_envio).toLocaleDateString()}</td>`;
                    } else if (tipo === 'ventas') {
                        html += `<td>${item.fecha}</td><td>${item.total_paquetes}</td><td>$${item.ingresos}</td>`;
                    } else if (tipo === 'empleados') {
                        html += `<td>${item.nombre}</td><td>${item.usuario}</td><td>${item.tipo}</td><td>${item.activo ? 'Activo' : 'Inactivo'}</td><td>${new Date(item.fecha_registro).toLocaleDateString()}</td>`;
                    } else if (tipo === 'vehiculos') {
                        html += `<td>${item.placa}</td><td>${item.marca}</td><td>${item.modelo}</td><td>${item.estado}</td><td>${item.empleado_nombre || 'Sin asignar'}</td>`;
                    }
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            contenedor.innerHTML = html;
        }
        
        function calcularPagos() {
            alert('Funci√≥n de calcular pagos - Por implementar');
        }
        
        function configurarTarifas() {
            alert('Funci√≥n de configurar tarifas - Por implementar');
        }
        
        function exportarPagos() {
            alert('Funci√≥n de exportar pagos - Por implementar');
        }
        5
        // Carga el √∫ltimo Excel descargado y lo renderiza en la tabla de Paquetes
async function cargarUltimoExcelEnPaquetes() {
    try {
        // 1) Pedir al servidor cu√°l es el archivo m√°s reciente
        const metaResp = await fetch('php/latest_excel.php', { cache: 'no-store' });
        const meta = await metaResp.json();
        if (!meta.exito) {
            alert('No se pudo localizar el Excel: ' + (meta.mensaje || 'Desconocido'));
            return;
        }

        // 2) Descargar el Excel como ArrayBuffer
        const fileResp = await fetch(meta.ruta_relativa, { cache: 'no-store' });
        if (!fileResp.ok) {
            throw new Error('No se pudo descargar el archivo Excel: ' + meta.ruta_relativa);
        }
        const buf = await fileResp.arrayBuffer();

        // 3) Parsear usando SheetJS (XLSX ya est√° incluido en la p√°gina)
        const wb = XLSX.read(buf, { type: 'array' });
        const hoja = wb.SheetNames[0];
        const ws = wb.Sheets[hoja];
        // header:1 => matriz de filas, defval:'' para no tener undefined
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        if (!rows || rows.length === 0) {
            alert('El Excel est√° vac√≠o o no tiene datos.');
            return;
        }

        // 4) Renderizar
        renderPaquetesDesdeExcel(rows);

        // 5) Actualizar m√©trica principal
        const total = rows.length > 1 ? (rows.length - 1) : 0;
        const totalLbl = document.getElementById('totalPaquetes');
        if (totalLbl) totalLbl.textContent = String(total);

        // 6) Asegurar que la secci√≥n Paquetes est√© visible
        const enlacePaquetes = document.querySelector('a[onclick*=\"paquetes\"]');
        if (enlacePaquetes) mostrarSeccion('paquetes', enlacePaquetes);

    } catch (e) {
        console.error('Error cargando y renderizando Excel:', e);
        alert('Error al cargar el Excel: ' + e.message);
    }
}
// Carga todos los paquetes desde BD y los pinta
async function cargarPaquetesDesdeBD() {
  try {
    const resp = await fetch('php/paquetes.php?limit=2000', { cache: 'no-store' });
    // Parseo robusto (si no fuese JSON, te muestra qu√© devolvi√≥)
    const raw = await resp.text();
    let data;
    try { data = JSON.parse(raw); } catch (e) {
      alert('Error cargando paquetes desde BD.\nLa respuesta no es JSON.\n\nCuerpo (primeros 2000 chars):\n' + raw.slice(0,2000));
      return;
    }
    if (!data.exito) throw new Error(data.mensaje || 'Error desconocido');

    const headers = data.headers && data.headers.length ? data.headers : inferHeaders(data.datos);
    renderPaquetesDesdeBD(headers, data.datos);

    const totalLbl = document.getElementById('totalPaquetes');
    if (totalLbl) totalLbl.textContent = String(data.total || data.datos.length || 0);

    // No cambiar de secci√≥n autom√°ticamente aqu√≠ para respetar la vista actual
  } catch (e) {
    console.error('Error cargando desde BD:', e);
    alert('Error cargando paquetes desde BD: ' + e.message);
  }
}
async function ejecutarSelenium() {
  try {
    const btn = document.getElementById('btnEjecutarSelenium');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Extrayendo datos...';
    }

    // Ejecuta Selenium para descargar el Excel (usa php/run_selenium.php)
    const resp = await fetch('php/run_selenium.php', { method: 'POST', cache: 'no-store' });
    const raw = await resp.text();
    let data;
    try { data = JSON.parse(raw); } catch (e) {
      alert('La respuesta de Selenium no es JSON.\n\nCuerpo:\n' + raw.slice(0,2000));
      return;
    }
    if (!data.exito) {
      alert('Selenium report√≥ error: ' + (data.mensaje || 'Desconocido'));
      return;
    }
    alert(data.mensaje || 'Descarga completada. Revisando Excel m√°s reciente...');

    // Opci√≥n A: cargar el √∫ltimo Excel en la tabla directamente
    if (typeof cargarUltimoExcelEnPaquetes === 'function') {
      await cargarUltimoExcelEnPaquetes();
    } else {
      // Opci√≥n B: si prefieres cargar desde BD (si ya importaste a BD)
      if (typeof cargarPaquetesDesdeBD === 'function') {
        await cargarPaquetesDesdeBD();
    // Despu√©s de mostrar datos manualmente, s√≠ navegar a Paquetes
    const enlacePaquetes = document.querySelector('a[onclick*="paquetes"]');
    if (enlacePaquetes) mostrarSeccion('paquetes', enlacePaquetes);
      }
    }
  } catch (e) {
    console.error('Error en ejecutarSelenium():', e);
    alert('Error ejecutando Selenium: ' + e.message);
  } finally {
    const btn = document.getElementById('btnEjecutarSelenium');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-play me-1"></i> Extracci√≥n de datos';
    }
  }
}
/* Importa todos los Excel de downloads/ a la BD y luego los muestra en la tabla */
async function importarDesdeDownloadsYMostrar() {
  try {
    const btn = document.getElementById('btnImportarDownloads');
    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mostrando datos...'; }

    const resp = await fetch('php/import_paquetes.php', { method: 'POST', cache: 'no-store' });
    const raw = await resp.text();
    let data;
    try { data = JSON.parse(raw); } catch (e) {
      alert('La respuesta de importaci√≥n no es JSON.\n\nCuerpo (primeros 2000 chars):\n' + raw.slice(0,2000));
      return;
    }
    if (!data.exito) {
      alert('Error al importar: ' + (data.mensaje || 'Desconocido'));
      return;
    }

    const detalle = Array.isArray(data.detalle)
      ? ('\n' + data.detalle.map(d => `- ${d.archivo || ''}: ${d.insertados ?? d.error}`).join('\n'))
      : '';
    alert(`Importaci√≥n completada. Insertados: ${data.insertados || 0}${detalle}`);

    await cargarPaquetesDesdeBD();
  } catch (e) {
    console.error('Error en importarDesdeDownloadsYMostrar:', e);
    alert('Error en importaci√≥n: ' + e.message);
  } finally {
    const btn = document.getElementById('btnImportarDownloads');
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-database me-1"></i> Mostrar datos'; }
  }
}

// Exponer en global para poder llamarla desde consola o botones
window.cargarPaquetesDesdeBD = cargarPaquetesDesdeBD;
window.inferHeaders = inferHeaders;
window.renderPaquetesDesdeBD = renderPaquetesDesdeBD;
// Si no vienen headers, intenta inferir por llaves del primer objeto
function inferHeaders(rows) {
  if (!Array.isArray(rows) || !rows.length) return [];
  return Object.keys(rows[0]);
}

function renderPaquetesDesdeBD(headers, rows) {
  const tabla = document.getElementById('tablaPaquetes');
  if (!tabla) return alert('No se encontr√≥ la tabla de Paquetes (id="tablaPaquetes").');
  const thead = tabla.querySelector('thead');
  const tbody = tabla.querySelector('tbody');
  if (!thead || !tbody) return alert('La tabla de Paquetes no tiene thead/tbody.');

  const esc = (s) => String(s ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Encabezados
  thead.innerHTML = '<tr>' + headers.map(h => `<th>${esc(h)}</th>`).join('') + '</tr>';

  // Cuerpo
  let html = '';
  for (const r of rows) {
    html += '<tr>' + headers.map(h => `<td>${esc(r[h])}</td>`).join('') + '</tr>';
  }
  tbody.innerHTML = html;
}
// Pinta headers y filas en #tablaPaquetes a partir de matriz [ [headers...], [row1...], ... ]
function renderPaquetesDesdeExcel(rows) {
    const tabla = document.getElementById('tablaPaquetes');
    if (!tabla) {
        alert('No se encontr√≥ la tabla de Paquetes (id="tablaPaquetes").');
        return;
    }
    const thead = tabla.querySelector('thead');
    const tbody = tabla.querySelector('tbody');
    if (!thead || !tbody) {
        alert('La tabla de Paquetes no tiene thead/tbody.');
        return;
    }

    // Primera fila = encabezados
    const headers = rows[0].map(h => String(h || '').trim());
    const dataRows = rows.slice(1);

    // Helper para evitar XSS en celdas
    const esc = (s) => String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    // Construir encabezados
    thead.innerHTML = '<tr>' + headers.map(h => `<th>${esc(h)}</th>`).join('') + '</tr>';

    // Construir cuerpo
    let html = '';
    for (const r of dataRows) {
        html += '<tr>' + headers.map((_, i) => `<td>${esc(r[i] ?? '')}</td>`).join('') + '</tr>';
    }
    tbody.innerHTML = html;
}
        // Funciones para cargar datos de empleados, veh√≠culos y rutas
        function cargarEmpleados() {
            console.log('Cargando empleados...');
            return fetch('php/admin.php?accion=empleados')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos recibidos:', data);
                    if (data.exito && Array.isArray(data.datos)) {
                        mostrarEmpleados(data.datos);
                    } else {
                        const errorMsg = data.mensaje || 'Formato de datos inesperado';
                        console.error('Error en la respuesta:', errorMsg);
                        throw new Error(errorMsg);
                    }
                    return data;
                })
                .catch(error => {
                    console.error('Error al cargar empleados:', error);
                    // Mostrar mensaje de error al usuario
                    alert('Error al cargar la lista de empleados. Por favor, intente nuevamente.');
                    throw error; // Re-lanzar el error para que pueda ser manejado por quien llame a esta funci√≥n
                });
        }
        
        function mostrarEmpleados(empleados) {
            console.log('Mostrando empleados:', empleados);
            const tbody = document.querySelector('#usuariosTable tbody');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento tbody dentro de la tabla con ID "usuariosTable"');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!Array.isArray(empleados) || empleados.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = '<td colspan="8" class="text-center">No hay empleados registrados</td>';
                tbody.appendChild(fila);
                return;
            }
            
            empleados.forEach(empleado => {
                const fila = document.createElement('tr');
                const fechaRegistro = empleado.fecha_registro ? new Date(empleado.fecha_registro).toLocaleDateString() : 'N/A';
                const tipoUsuario = empleado.tipo === 'admin' ? 'Administrador' : 
                                  empleado.tipo === 'asistente' ? 'Asistente' : 'Empleado';
                
                fila.innerHTML = `
                    <td>${empleado.id || ''}</td>
                    <td>${empleado.nombre || 'N/A'}</td>
                    <td>${empleado.usuario || 'N/A'}</td>
                    <td>${empleado.email || 'N/A'}</td>
                    <td>${tipoUsuario}</td>
                    <td><span class="estado estado-${empleado.activo ? 'activo' : 'inactivo'}">
                        ${empleado.activo ? 'Activo' : 'Inactivo'}
                    </span></td>
                    <td>${fechaRegistro}</td>
                    <td>
                        <button class="btn btn-pequeno btn-secundario" onclick="eliminarEmpleado(${empleado.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(fila);
            });
        }
        
        function cargarVehiculos() {
            console.log('Iniciando carga de veh√≠culos...');
            return fetch('php/admin.php?accion=vehiculos')
                .then(response => {
                    console.log('Respuesta recibida, estado:', response.status);
                    if (!response.ok) {
                        throw new Error(`Error en la respuesta del servidor: ${response.status} ${response.statusText}`);
                    }
                    return response.json().catch(e => {
                        console.error('Error al parsear JSON:', e);
                        throw new Error('La respuesta no es un JSON v√°lido');
                    });
                })
                .then(data => {
                    console.log('Datos recibidos de veh√≠culos:', data);
                    if (data && data.exito) {
                        if (Array.isArray(data.datos)) {
                            console.log(`Mostrando ${data.datos.length} veh√≠culos`);
                            mostrarVehiculos(data.datos);
                        } else {
                            console.error('Los datos no son un array:', data.datos);
                            throw new Error('Formato de datos incorrecto: se esperaba un array de veh√≠culos');
                        }
                    } else {
                        const errorMsg = data && data.mensaje ? data.mensaje : 'Error desconocido';
                        console.error('Error en la respuesta:', errorMsg);
                        throw new Error(errorMsg);
                    }
                })
                .catch(error => {
                    console.error('Error en cargarVehiculos:', error);
                    const tbody = document.getElementById('cuerpoTablaVehiculos');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" class="error">
                                    Error al cargar veh√≠culos: ${error.message}
                                </td>
                            </tr>`;
                    }
                    throw error; // Re-lanzar para manejo posterior si es necesario
                });
        }
        
        function mostrarVehiculos(vehiculos) {
            const tbody = document.getElementById('cuerpoTablaVehiculos');
            tbody.innerHTML = '';
            
            if (!vehiculos || !Array.isArray(vehiculos)) {
                console.error('Error: Los datos de veh√≠culos no son v√°lidos', vehiculos);
                return;
            }
            
            if (vehiculos.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = '<td colspan="8" class="texto-centrado">No hay veh√≠culos registrados</td>';
                tbody.appendChild(fila);
                return;
            }
            
            vehiculos.forEach(vehiculo => {
                try {
                    const fila = document.createElement('tr');
                    const estadoClase = (vehiculo.estado || '').toLowerCase().replace(/ /g, '-');
                    
                    fila.innerHTML = `
                        <td>${vehiculo.id || ''}</td>
                        <td>${vehiculo.placa || ''}</td>
                        <td>${vehiculo.marca || ''}</td>
                        <td>${vehiculo.modelo || ''}</td>
                        <td>${vehiculo.capacidad ? parseFloat(vehiculo.capacidad).toFixed(2) + ' kg' : '0.00 kg'}</td>
                        <td>
                            <span class="estado estado-${estadoClase}">
                                ${vehiculo.estado_mostrar || vehiculo.estado || 'Desconocido'}
                            </span>
                        </td>
                        <td>${vehiculo.empleado_nombre || 'Sin asignar'}</td>
                        <td>
                            <button class="btn btn-pequeno btn-secundario" 
                                    onclick="eliminarVehiculo(${vehiculo.id})"
                                    ${vehiculo.estado === 'en_ruta' ? 'disabled' : ''}>
                                Eliminar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(fila);
                } catch (error) {
                    console.error('Error al mostrar veh√≠culo:', error, vehiculo);
                }
            });
        }
        
        function cargarRutas() {
            fetch('php/admin.php?accion=rutas')
                .then(response => response.json())
                .then(data => {
                    if (data.exito) {
                        mostrarRutas(data.datos);
                    } else {
                        console.error('Error al cargar rutas:', data.mensaje);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function mostrarRutas(rutas) {
            const tbody = document.getElementById('cuerpoTablaRutas');
            tbody.innerHTML = '';
            
            rutas.forEach(ruta => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${ruta.id}</td>
                    <td>${ruta.nombre}</td>
                    <td>${ruta.origen}</td>
                    <td>${ruta.destino}</td>
                    <td>${ruta.distancia}</td>
                    <td>${ruta.tiempo_estimado}</td>
                    <td>
                        <button class="btn btn-pequeno btn-secundario" onclick="eliminarRuta(${ruta.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(fila);
            });
        }
        
        // Funciones para eliminar registros
        function eliminarEmpleado(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este empleado?')) {
                const formData = new FormData();
                formData.append('accion', 'eliminar_empleado');
                formData.append('id', id);
                
                fetch('php/admin.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exito) {
                        alert('Empleado eliminado exitosamente');
                        cargarEmpleados();
                    } else {
                        alert('Error al eliminar empleado: ' + data.mensaje);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar empleado');
                });
            }
        }
        
        function eliminarVehiculo(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este veh√≠culo?')) {
                const formData = new FormData();
                formData.append('accion', 'eliminar_vehiculo');
                formData.append('id', id);
                
                fetch('php/admin.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exito) {
                        alert('Veh√≠culo eliminado exitosamente');
                        cargarVehiculos();
                    } else {
                        alert('Error al eliminar veh√≠culo: ' + data.mensaje);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar veh√≠culo');
                });
            }
        }
        
        function eliminarRuta(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta ruta?')) {
                const formData = new FormData();
                formData.append('accion', 'eliminar_ruta');
                formData.append('id', id);
                
                fetch('php/admin.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exito) {
                        alert('Ruta eliminada exitosamente');
                        cargarRutas();
                    } else {
                        alert('Error al eliminar ruta: ' + data.mensaje);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar ruta');
                });
            }
        }
        
        // Funci√≥n para mostrar secciones
        function mostrarSeccion(seccion, elemento) {
            // Prevenir comportamiento por defecto del enlace
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // No hacer nada si ya estamos en esa secci√≥n
            const seccionActual = document.querySelector('.seccion.activa');
            if (seccionActual && seccionActual.id === 'seccion-' + seccion) {
                return false;
            }
            
            // Ocultar todas las secciones
            const secciones = document.querySelectorAll('.seccion');
            secciones.forEach(s => s.classList.remove('activa'));
            
            // Mostrar la secci√≥n seleccionada
            const seccionElemento = document.getElementById('seccion-' + seccion);
            if (seccionElemento) {
                seccionElemento.classList.add('activa');
            }
            
            // Actualizar men√∫ activo
            const menuItems = document.querySelectorAll('.menu a');
            menuItems.forEach(item => item.classList.remove('activo'));
            
            // Agregar clase activa al elemento clickeado
            if (elemento) {
                elemento.classList.add('activo');
            }
            
            // Actualizar t√≠tulo
            const titulos = {
                'dashboard': 'Panel de Administraci√≥n',
                'empleados': 'Gesti√≥n de Empleados',
                'vehiculos': 'Gesti√≥n de Veh√≠culos',
                'rutas': 'Gesti√≥n de Rutas',
                'reportes': 'Reportes',
                'pagos': 'Pagos Empleados'
            };
            document.getElementById('tituloSeccion').textContent = titulos[seccion] || 'Panel de Administraci√≥n';
            
            return false;
        }

        // Cerrar modales al hacer clic fuera de ellos
        window.onclick = function(event) {
            const modales = document.querySelectorAll('.modal');
            modales.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // C√≥digo para el men√∫ m√≥vil y carga de datos
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del men√∫ m√≥vil
            const btnMenu = document.getElementById('btnMenuMovil');
            const barraLateral = document.getElementById('barraLateral');
            const contenidoPrincipal = document.querySelector('.contenido-principal');
            
            // Cargar datos cuando se muestre la secci√≥n correspondiente
            const secciones = document.querySelectorAll('.seccion');
            const observador = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        switch(entry.target.id) {
                            case 'seccion-empleados':
                                cargarEmpleados().catch(console.error);
                                break;
                            case 'seccion-vehiculos':
                                cargarVehiculos().catch(console.error);
                                break;
                            // Agrega m√°s casos seg√∫n sea necesario
                        }
                    }
                });
            }, { threshold: 0.1 });
            
            // Observar cada secci√≥n
            secciones.forEach(seccion => {
                observador.observe(seccion);
            });
            
            // Cargar empleados por defecto si estamos en la secci√≥n de empleados
            if (window.location.hash === '#seccion-empleados') {
                cargarEmpleados().catch(console.error);
            }
            let menuAbierto = false;

            function toggleMenu() {
                menuAbierto = !menuAbierto;
                barraLateral.classList.toggle('activa', menuAbierto);
                contenidoPrincipal.classList.toggle('desplazado', menuAbierto);
                document.body.style.overflow = menuAbierto ? 'hidden' : '';
                
                // Cambiar √≠cono
                const icono = btnMenu.querySelector('i');
                if (menuAbierto) {
                    icono.classList.remove('fa-bars');
                    icono.classList.add('fa-times');
                } else {
                    icono.classList.remove('fa-times');
                    icono.classList.add('fa-bars');
                }
            }

            // Evento para el bot√≥n del men√∫
            if (btnMenu) {
                btnMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleMenu();
                });
            }

            // Cerrar men√∫ al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (menuAbierto && !barraLateral.contains(e.target) && e.target !== btnMenu) {
                    toggleMenu();
                }
            });

            // Cerrar men√∫ al redimensionar la ventana
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 992 && menuAbierto) {
                        toggleMenu();
                    }
                }, 250);
            });

            // Prevenir navegaci√≥n hacia atr√°s despu√©s de cerrar sesi√≥n
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function(event) {
                window.history.pushState(null, null, window.location.href);
            };

            // Verificar sesi√≥n al cargar la p√°gina
            fetch('php/verificar_sesion.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.sesion_activa || data.usuario.tipo !== 'admin') {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Actualizar informaci√≥n del usuario
                    document.getElementById('nombreUsuario').textContent = data.usuario.nombre;
                    
                    // Cargar todos los datos al iniciar (incluye paquetes desde BD)
                    cargarPaquetesDesdeBD();
                    cargarEmpleados();
                    cargarVehiculos();
                    cargarRutas();
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = 'login.html';
                });
        });
    </script>
    
    <!-- jQuery (debe cargarse primero) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- DataTables y sus dependencias -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Bibliotecas para exportaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Nuestros scripts -->
    <script src="js/gestion_usuarios.js"></script>
    <script src="js/exportar.js"></script>
    
    <!-- Inicializaci√≥n de la p√°gina -->
    <script>
        $(document).ready(function() {
            // Verificar que todas las dependencias est√©n cargadas
            if (typeof jQuery == 'undefined') {
                console.error('Error: jQuery no se ha cargado correctamente');
            } else {
                console.log('jQuery versi√≥n:', $.fn.jquery);
            }
            
            if (typeof bootstrap === 'undefined') {
                console.error('Error: Bootstrap no se ha cargado correctamente');
            } else {
                console.log('Bootstrap cargado correctamente');
            }
            
            // Cargar datos iniciales si es necesario
            if (window.location.hash) {
                const seccion = window.location.hash.substring(1);
                const elementoMenu = document.querySelector(`a[onclick*="${seccion}"]`);
                if (elementoMenu) {
                    mostrarSeccion(seccion, elementoMenu);
                }
            } else {
                // Por defecto, mostrar el dashboard
                mostrarSeccion('dashboard', document.querySelector('a[onclick*="dashboard"]'));
            }
        });
    </script>
</body>
</html>