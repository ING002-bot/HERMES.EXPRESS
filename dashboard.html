<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Panel de administraci√≥n HERMES EXPRESS LOGISTIC">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Manifest para PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/img/icon-192x192.png">
    
    <!-- Preload de fuentes cr√≠ticas -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Precargar CSS cr√≠tico -->
    <link rel="preload" href="css/dashboard.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="css/dashboard-responsive.css">
    <noscript>
        <link rel="stylesheet" href="css/dashboard.css">
        <link rel="stylesheet" href="css/dashboard-responsive.css">
    </noscript>
    
    <!-- Cargar Font Awesome de forma as√≠ncrona -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    <title>HERMES - Dashboard</title>
</head>
<body>
    <div class="contenedor">
        <!-- Bot√≥n de men√∫ m√≥vil -->
        <button class="menu-movil" id="btnMenuMovil" aria-label="Men√∫">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Barra lateral -->
        <nav class="barra-lateral" id="barraLateral">
            <div class="logo">
                <h2>HERMES EXPRESS</h2>
                <small>LOGISTIC</small>
            </div>
            
            <ul class="menu">
                <li><a href="#inicio" class="activo" onclick="mostrarSeccion('inicio')">
                    <span class="icono">üè†</span>Inicio
                </a></li>
                <li><a href="#paquetes" onclick="mostrarSeccion('paquetes')">
                    <span class="icono">üì¶</span>Paquetes
                </a></li>
                <li><a href="#rutas" onclick="mostrarSeccion('rutas')">
                    <span class="icono">üó∫Ô∏è</span>Rutas
                </a></li>
                <li><a href="#vehiculos" onclick="mostrarSeccion('vehiculos')">
                    <span class="icono">üöõ</span>Veh√≠culos
                </a></li>
                <li><a href="#reportes" onclick="mostrarSeccion('reportes')">
                    <span class="icono">üìä</span>Reportes
                </a></li>
            </ul>
            
            <div class="usuario-info">
                <div class="avatar">üë§</div>
                <div class="info">
                    <p id="nombreUsuario">Usuario</p>
                    <small id="tipoUsuario">Empleado</small>
                </div>
                <button onclick="cerrarSesion()" class="btn-salir">üö™</button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="contenido-principal">
            <header class="cabecera">
                <h1 id="tituloSeccion">Dashboard</h1>
                <div class="acciones">
                    <!-- Botones de Nuevo Paquete y Actualizar eliminados -->
                </div>
            </header>

            <!-- Secci√≥n Inicio -->
            <section id="seccion-inicio" class="seccion activa">
                <div class="tarjetas-resumen">
                    <div class="tarjeta">
                        <div class="icono-tarjeta">üì¶</div>
                        <div class="info-tarjeta">
                            <h3 id="totalPaquetes">0</h3>
                            <p>Total Paquetes</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">üöõ</div>
                        <div class="info-tarjeta">
                            <h3 id="enTransito">0</h3>
                            <p>En Tr√°nsito</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">‚úÖ</div>
                        <div class="info-tarjeta">
                            <h3 id="entregados">0</h3>
                            <p>Entregados</p>
                        </div>
                    </div>
                    <div class="tarjeta">
                        <div class="icono-tarjeta">üí∞</div>
                        <div class="info-tarjeta">
                            <h3 id="ingresos">S/ 0</h3>
                            <p>Ingresos Hoy</p>
                        </div>
                    </div>
                </div>

                <div class="graficos">
                    <div class="grafico-container">
                        <h3>Paquetes por Estado</h3>
                        <canvas id="graficoEstados" width="400" height="200"></canvas>
                    </div>
                    <div class="actividad-reciente">
                        <h3>Actividad Reciente</h3>
                        <div id="listaActividad" class="lista-actividad">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Paquetes -->
            <section id="seccion-paquetes" class="seccion">
                <div class="filtros">
                    <input type="text" id="buscarPaquete" placeholder="Buscar por c√≥digo o destinatario...">
                    <select id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="en_transito">En Tr√°nsito</option>
                        <option value="entregado">Entregado</option>
                        <option value="devuelto">Devuelto</option>
                    </select>
                </div>
                
                <div class="tabla-container">
                    <table id="tablaPaquetes">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Remitente</th>
                                <th>Destinatario</th>
                                <th>Estado</th>
                                <th>Peso</th>
                                <th>Precio</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaPaquetes">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Secci√≥n Rutas -->
            <section id="seccion-rutas" class="seccion">
                <div class="acciones-seccion">
                    <button class="btn btn-primario" onclick="nuevaRuta()">+ Nueva Ruta</button>
                </div>
                <div id="listaRutas" class="lista-rutas">
                    <!-- Se llena din√°micamente -->
                </div>
            </section>

            <!-- Secci√≥n Veh√≠culos -->
            <section id="seccion-vehiculos" class="seccion">
                <div class="acciones-seccion">
                    <button class="btn btn-primario" onclick="nuevoVehiculo()">+ Nuevo Veh√≠culo</button>
                </div>
                <div id="listaVehiculos" class="lista-vehiculos">
                    <!-- Se llena din√°micamente -->
                </div>
            </section>

            <!-- Secci√≥n Reportes -->
            <section id="seccion-reportes" class="seccion">
                <div class="filtros-reporte">
                    <input type="date" id="fechaInicio">
                    <input type="date" id="fechaFin">
                    <button class="btn btn-primario" onclick="generarReporte()">Generar Reporte</button>
                </div>
                <div id="contenidoReporte" class="contenido-reporte">
                    <!-- Se llena din√°micamente -->
                </div>
            </section>
        </main>
    </div>


    <script>
        // Manejar el men√∫ m√≥vil
        document.addEventListener('DOMContentLoaded', function() {
            const btnMenu = document.getElementById('btnMenuMovil');
            const barraLateral = document.getElementById('barraLateral');
            const contenidoPrincipal = document.querySelector('.contenido-principal');
            const enlacesMenu = document.querySelectorAll('.menu a');
            let menuAbierto = false;

            // Alternar men√∫ m√≥vil
            function toggleMenu() {
                menuAbierto = !menuAbierto;
                barraLateral.classList.toggle('activa', menuAbierto);
                contenidoPrincipal.classList.toggle('desplazado', menuAbierto);
                
                // Cambiar √≠cono del bot√≥n
                const icono = btnMenu.querySelector('i');
                if (menuAbierto) {
                    icono.classList.remove('fa-bars');
                    icono.classList.add('fa-times');
                    document.body.style.overflow = 'hidden'; // Evitar scroll del body cuando el men√∫ est√° abierto
                } else {
                    icono.classList.remove('fa-times');
                    icono.classList.add('fa-bars');
                    document.body.style.overflow = ''; // Restaurar scroll
                }
            }

            // Cerrar men√∫ al hacer clic en un enlace
            function cerrarMenu() {
                if (window.innerWidth <= 992) {
                    menuAbierto = true;
                    toggleMenu();
                }
            }

            // Event listeners
            btnMenu.addEventListener('click', toggleMenu);
            enlacesMenu.forEach(enlace => {
                enlace.addEventListener('click', cerrarMenu);
            });

            // Cerrar men√∫ al hacer clic fuera
            contenidoPrincipal.addEventListener('click', function(e) {
                if (menuAbierto && !e.target.closest('.barra-lateral')) {
                    toggleMenu();
                }
            });

            // Ajustar men√∫ al cambiar el tama√±o de la ventana
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992) {
                    // Restablecer estilos en pantallas grandes
                    barraLateral.classList.remove('activa');
                    contenidoPrincipal.classList.remove('desplazado');
                    document.body.style.overflow = '';
                    menuAbierto = false;
                    const icono = btnMenu.querySelector('i');
                    icono.classList.remove('fa-times');
                    icono.classList.add('fa-bars');
                }
            });
        });

        // Cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                // Limpiar el almacenamiento local si es necesario
                if (typeof(Storage) !== 'undefined') {
                    localStorage.removeItem('sesion_activa');
                    sessionStorage.clear();
                }
                
                // Realizar la petici√≥n de cierre de sesi√≥n
                fetch('php/cerrar_sesion.php', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                    }
                })
                .then(response => {
                    // Asegurarse de que la redirecci√≥n ocurra incluso si hay un error en la respuesta
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    // Forzar recarga sin cach√©
                    window.location.replace('login.html');
                })
                .catch(error => {
                    console.error('Error al cerrar sesi√≥n:', error);
                    // Redirigir de todas formas
                    window.location.replace('login.html');
                });
            }
        }

        // Otras funciones del dashboard
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            const secciones = document.querySelectorAll('.seccion');
            secciones.forEach(s => s.classList.remove('activa'));
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById('seccion-' + seccion).classList.add('activa');
            
            // Actualizar men√∫ activo
            const menuItems = document.querySelectorAll('.menu a');
            menuItems.forEach(item => item.classList.remove('activo'));
            event.target.classList.add('activo');
            
            // Actualizar t√≠tulo
            const titulos = {
                'inicio': 'Dashboard',
                'paquetes': 'Gesti√≥n de Paquetes',
                'rutas': 'Gesti√≥n de Rutas',
                'vehiculos': 'Gesti√≥n de Veh√≠culos',
                'reportes': 'Reportes'
            };
            document.getElementById('tituloSeccion').textContent = titulos[seccion] || 'Dashboard';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function actualizar() {
            location.reload();
        }

        // Prevenir navegaci√≥n hacia atr√°s despu√©s de cerrar sesi√≥n
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function(event) {
            window.history.pushState(null, null, window.location.href);
        };

        // Registrar Service Worker para cach√© y funcionalidad offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Detectar si la aplicaci√≥n se est√° ejecutando en modo standalone (PWA)
        window.addEventListener('load', function() {
            let isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                                   window.navigator.standalone;
            
            if (isInStandaloneMode) {
                console.log('La aplicaci√≥n se est√° ejecutando en modo PWA');
                document.documentElement.classList.add('pwa-mode');
            }
        });

        // Verificar sesi√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            fetch('php/verificar_sesion.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.sesion_activa || data.usuario.tipo !== 'asistente') {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Actualizar informaci√≥n del usuario
                    document.getElementById('nombreUsuario').textContent = data.usuario.nombre;
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = 'login.html';
                });
        });
    </script>
    <script src="js/dashboard.js"></script>
</body>
</html>