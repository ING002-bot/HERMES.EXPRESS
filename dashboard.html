<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#007bff">
  <meta name="description" content="Panel de administraci√≥n HERMES EXPRESS LOGISTIC">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/img/icon-192x192.png">

  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="css/paneladmin.css">
  <link rel="stylesheet" href="css/paneladmin-responsive.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">

  <title>HERMES - Panel de Control</title>
</head>
<body>
  <div class="contenedor">
    <button class="menu-movil" id="btnMenuMovil" aria-label="Men√∫">
      <i class="fas fa-bars"></i>
    </button>

    <nav class="barra-lateral" id="barraLateral">
      <div class="logo">
        <h2>HERMES EXPRESS LOGISTIC</h2>
      </div>
      <ul class="menu">
        <li><a href="javascript:void(0)" class="activo" onclick="mostrarSeccion('dashboard', this)"><span class="icono">üìä</span>Dashboard</a></li>
        <li><a href="javascript:void(0)" onclick="mostrarSeccion('paquetes', this)"><span class="icono">üì¶</span>Paquetes</a></li>
        <li><a href="javascript:void(0)" onclick="mostrarSeccion('rutas', this)"><span class="icono">üó∫Ô∏è</span>Rutas</a></li>
        <li><a href="javascript:void(0)" onclick="mostrarSeccion('vehiculos', this)"><span class="icono">üöõ</span>Veh√≠culos</a></li>
        <li><a href="javascript:void(0)" onclick="mostrarSeccion('reportes', this)"><span class="icono">üìä</span>Reportes</a></li>
        <li><a href="javascript:void(0)" onclick="mostrarSeccion('asignar', this)"><span class="icono">üß©</span>Asignar</a></li>
      </ul>
      <div class="usuario-info">
        <div class="avatar">üë§</div>
        <div class="info">
          <p id="nombreUsuario">Usuario</p>
          <small>Asistente</small>
        </div>
        <button onclick="cerrarSesion()" class="btn-salir">üö™</button>
      </div>
    </nav>

    <main class="contenido-principal">
      <header class="cabecera">
        <h1 id="tituloSeccion">Panel de Control</h1>
        <div class="acciones"></div>
      </header>

      <section id="seccion-dashboard" class="seccion activa">
        <div class="metricas-principales">
          <div class="tarjeta-metrica">
            <div class="icono-metrica">üì¶</div>
            <div class="info-metrica">
              <h3 id="totalPaquetes">0</h3>
              <p>Total Paquetes</p>
            </div>
          </div>
          <div class="tarjeta-metrica">
            <div class="icono-metrica">üí∞</div>
            <div class="info-metrica">
              <h3 id="ingresosMes">$0</h3>
              <p>Ingresos del Mes</p>
            </div>
          </div>
          <div class="tarjeta-metrica">
            <div class="icono-metrica">üë•</div>
            <div class="info-metrica">
              <h3 id="empleadosActivos">0</h3>
              <p>Empleados Activos</p>
            </div>
          </div>
          <div class="tarjeta-metrica">
            <div class="icono-metrica">üöõ</div>
            <div class="info-metrica">
              <h3 id="vehiculosOperativos">0</h3>
              <p>Veh√≠culos Operativos</p>
            </div>
          </div>
        </div>

        <div class="graficos-admin">
          <div class="grafico-ventas">
            <h3>Ingresos por Mes</h3>
            <canvas id="graficoVentas" width="600" height="300"></canvas>
          </div>
          <div class="actividad-reciente">
            <h3>Actividad Reciente</h3>
            <div id="listaActividad" class="lista-actividad"></div>
          </div>
        </div>
      </section>

      <section id="seccion-paquetes" class="seccion">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="filtros" style="margin-right: auto;">
            <input type="text" id="buscarPaquete" placeholder="Buscar por c√≥digo o destinatario...">
            <select id="filtroEstado">
              <option value="">Todos los estados</option>
              <option value="pendiente">Pendiente</option>
              <option value="en_transito">En Tr√°nsito</option>
              <option value="entregado">Entregado</option>
              <option value="devuelto">Devuelto</option>
            </select>
          </div>
          <div class="d-flex">
            <button class="btn btn-exportar me-2" onclick="exportarAPDF('paquetes')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
            <button class="btn btn-exportar me-2" onclick="exportarAExcel('paquetes')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button id="btnEjecutarSelenium" class="btn btn-primario" onclick="ejecutarSelenium()">
              <i class="fas fa-play me-1"></i> Extracci√≥n de datos
            </button>
            <button id="btnImportarDownloads" class="btn btn-exito ms-2" onclick="importarDesdeDownloadsYMostrar()" title="Importar TODOS los Excel de downloads/ a la BD y mostrarlos">
              <i class="fas fa-database me-1"></i> Mostrar datos
            </button>
          </div>
        </div>
        <div class="tabla-container">
          <table id="tablaPaquetes">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Remitente</th>
                <th>Destinatario</th>
                <th>Estado</th>
                <th>Peso</th>
                <th>Precio</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaPaquetes"></tbody>
          </table>
        </div>
      </section>

      <section id="seccion-rutas" class="seccion">
        <div class="acciones-seccion">
          <button class="btn btn-primario" onclick="nuevaRuta()">+ Nueva Ruta</button>
        </div>
        <div id="listaRutas" class="lista-rutas"></div>
      </section>

      <section id="seccion-vehiculos" class="seccion">
        <div class="acciones-seccion">
          <button class="btn btn-primario" onclick="nuevoVehiculo()">+ Nuevo Veh√≠culo</button>
        </div>
        <div id="listaVehiculos" class="lista-vehiculos"></div>
      </section>

      <section id="seccion-reportes" class="seccion">
        <div class="filtros-reporte">
          <input type="date" id="fechaInicio">
          <input type="date" id="fechaFin">
          <button class="btn btn-primario" onclick="generarReporte()">Generar Reporte</button>
        </div>
        <div id="contenidoReporte" class="contenido-reporte"></div>
      </section>

      <section id="seccion-asignar" class="seccion">
        <div class="seccion-header">
          <h2>Asignar Paquetes por Distrito</h2>
          <p>Selecciona un empleado y distritos para asignar los paquetes correspondientes.</p>
        </div>
        <div class="asignar-contenedor">
          <div class="form-grupo">
            <label for="selEmpleadoAsignar">Empleado:</label>
            <select id="selEmpleadoAsignar" class="form-select">
              <option value="">Seleccione empleado...</option>
            </select>
          </div>
          <div class="form-grupo">
            <label for="selDistritosAsignar">Distritos (m√∫ltiple):</label>
            <select id="selDistritosAsignar" class="form-select" multiple size="8" style="min-width:260px;"></select>
          </div>
          <div class="form-acciones">
            <button class="btn btn-primario" onclick="asignarPaquetesPorDistrito()">
              <i class="fas fa-share-square me-1"></i> Asignar seleccionados
            </button>
          </div>
          <div id="resultadoAsignacion" class="mt-2"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnMenu = document.getElementById('btnMenuMovil');
      const barraLateral = document.getElementById('barraLateral');
      const contenidoPrincipal = document.querySelector('.contenido-principal');
      const enlacesMenu = document.querySelectorAll('.menu a');
      let menuAbierto = false;

      function toggleMenu() {
        menuAbierto = !menuAbierto;
        barraLateral.classList.toggle('activa', menuAbierto);
        contenidoPrincipal.classList.toggle('desplazado', menuAbierto);
        const icono = btnMenu.querySelector('i');
        if (menuAbierto) {
          icono.classList.replace('fa-bars', 'fa-times');
          document.body.style.overflow = 'hidden';
        } else {
          icono.classList.replace('fa-times', 'fa-bars');
          document.body.style.overflow = '';
        }
      }

      function cerrarMenu() {
        if (window.innerWidth <= 992) {
          menuAbierto = true;
          toggleMenu();
        }
      }

      btnMenu.addEventListener('click', toggleMenu);
      enlacesMenu.forEach(enlace => enlace.addEventListener('click', cerrarMenu));
      contenidoPrincipal.addEventListener('click', e => {
        if (menuAbierto && !e.target.closest('.barra-lateral')) toggleMenu();
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 992) {
          barraLateral.classList.remove('activa');
          contenidoPrincipal.classList.remove('desplazado');
          document.body.style.overflow = '';
          menuAbierto = false;
          const icono = btnMenu.querySelector('i');
          icono.classList.replace('fa-times', 'fa-bars');
        }
      });
    });

    function cerrarSesion() {
      if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        if (typeof Storage !== 'undefined') {
          localStorage.removeItem('sesion_activa');
          sessionStorage.clear();
        }
        fetch('php/cerrar_sesion.php', {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'Cache-Control': 'no-cache,no-store', 'Pragma': 'no-cache' }
        })
        .then(r => {
          if (!r.ok) throw new Error('Error');
          window.location.replace('login.html');
        })
        .catch(() => window.location.replace('login.html'));
      }
    }

    function mostrarSeccion(seccion) {
      document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
      document.getElementById('seccion-' + seccion).classList.add('activa');
      document.querySelectorAll('.menu a').forEach(i => i.classList.remove('activo'));
      event.target.classList.add('activo');
      const titulos = {
        inicio: 'Dashboard',
        paquetes: 'Gesti√≥n de Paquetes',
        rutas: 'Gesti√≥n de Rutas',
        vehiculos: 'Gesti√≥n de Veh√≠culos',
        reportes: 'Reportes'
      };
      document.getElementById('tituloSeccion').textContent = titulos[seccion] || 'Dashboard';
    }

    function cerrarModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function actualizar() {
      location.reload();
    }

    window.history.pushState(null, null, window.location.href);
    window.onpopstate = () => {
      window.history.pushState(null, null, window.location.href);
    };

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('ServiceWorker ok'))
          .catch(err => console.log('SW fail:', err));
      });
    }

    window.addEventListener('load', () => {
      let pwa = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      if (pwa) {
        console.log('Modo PWA');
        document.documentElement.classList.add('pwa-mode');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetch('php/verificar_sesion.php')
        .then(r => r.json())
        .then(d => {
          if (!d.sesion_activa || d.usuario.tipo !== 'asistente') {
            window.location.href = 'login.html';
            return;
          }
          document.getElementById('nombreUsuario').textContent = d.usuario.nombre;
          // Cargar paquetes desde BD al iniciar para que se muestren al entrar o al refrescar
          cargarPaquetesDesdeBD();
          // Pre-cargar selects de Asignar
          cargarEmpleadosAsignar();
          cargarDistritosAsignar();
        })
        .catch(() => window.location.href = 'login.html');
    });
  </script>

  <!-- Bibliotecas para exportaci√≥n como en paneladmin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="js/exportar.js"></script>

  <script>
    // Funciones tra√≠das/adaptadas desde paneladmin.html
    async function ejecutarSelenium() {
      try {
        const btn = document.getElementById('btnEjecutarSelenium');
        if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Extrayendo datos...'; }
        const resp = await fetch('php/run_selenium.php', { method: 'POST', cache: 'no-store' });
        const raw = await resp.text();
        let data;
        try { data = JSON.parse(raw); } catch (e) {
          alert('La respuesta de Selenium no es JSON.\n\nCuerpo:\n' + raw.slice(0,2000));
          return;
        }
        if (!data.exito) { alert('Selenium report√≥ error: ' + (data.mensaje || 'Desconocido')); return; }
        alert(data.mensaje || 'Descarga completada.');
        if (typeof cargarPaquetesDesdeBD === 'function') {
          await cargarPaquetesDesdeBD();
          const enlace = document.querySelector('a[onclick*="paquetes"]');
          if (enlace) mostrarSeccion('paquetes', enlace);
        }
      } catch (e) {
        console.error('Error en ejecutarSelenium():', e);
        alert('Error ejecutando Selenium: ' + e.message);
      } finally {
        const btn = document.getElementById('btnEjecutarSelenium');
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-play me-1"></i> Extracci√≥n de datos'; }
      }
    }

    async function importarDesdeDownloadsYMostrar() {
      try {
        const btn = document.getElementById('btnImportarDownloads');
        if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mostrando datos...'; }
        const resp = await fetch('php/import_paquetes.php', { method: 'POST', cache: 'no-store' });
        const raw = await resp.text();
        let data;
        try { data = JSON.parse(raw); } catch (e) {
          alert('La respuesta de importaci√≥n no es JSON.\n\nCuerpo (primeros 2000 chars):\n' + raw.slice(0,2000));
          return;
        }
        if (!data.exito) { alert('Error al importar: ' + (data.mensaje || 'Desconocido')); return; }
        const detalle = Array.isArray(data.detalle)
          ? ('\n' + data.detalle.map(d => `- ${d.archivo || ''}: ${d.insertados ?? d.error}`).join('\n'))
          : '';
        alert(`Importaci√≥n completada. Insertados: ${data.insertados || 0}${detalle}`);
        await cargarPaquetesDesdeBD();
        const enlace = document.querySelector('a[onclick*="paquetes"]');
        if (enlace) mostrarSeccion('paquetes', enlace);
      } catch (e) {
        console.error('Error en importarDesdeDownloadsYMostrar:', e);
        alert('Error en importaci√≥n: ' + e.message);
      } finally {
        const btn = document.getElementById('btnImportarDownloads');
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-database me-1"></i> Mostrar datos'; }
      }
    }

    async function cargarPaquetesDesdeBD() {
      try {
        const resp = await fetch('php/paquetes.php?limit=2000', { cache: 'no-store' });
        const raw = await resp.text();
        let data;
        try { data = JSON.parse(raw); } catch (e) {
          alert('Error cargando paquetes desde BD.\nLa respuesta no es JSON.\n\nCuerpo (primeros 2000 chars):\n' + raw.slice(0,2000));
          return;
        }
        if (!data.exito) throw new Error(data.mensaje || 'Error desconocido');
        const headers = data.headers && data.headers.length ? data.headers : inferHeaders(data.datos);
        renderPaquetesDesdeBD(headers, data.datos);
        const totalLbl = document.getElementById('totalPaquetes');
        if (totalLbl) totalLbl.textContent = String(data.total || data.datos.length || 0);
      } catch (e) {
        console.error('Error cargando desde BD:', e);
        alert('Error cargando paquetes desde BD: ' + e.message);
      }
    }

    function inferHeaders(rows) {
      if (!Array.isArray(rows) || !rows.length) return [];
      return Object.keys(rows[0]);
    }

    function renderPaquetesDesdeBD(headers, rows) {
      const tabla = document.getElementById('tablaPaquetes');
      if (!tabla) return alert('No se encontr√≥ la tabla de Paquetes (id="tablaPaquetes").');
      const thead = tabla.querySelector('thead');
      const tbody = tabla.querySelector('tbody');
      if (!thead || !tbody) return alert('La tabla de Paquetes no tiene thead/tbody.');
      const esc = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      thead.innerHTML = '<tr>' + headers.map(h => `<th>${esc(h)}</th>`).join('') + '</tr>';
      let html = '';
      for (const r of rows) { html += '<tr>' + headers.map(h => `<td>${esc(r[h])}</td>`).join('') + '</tr>'; }
      tbody.innerHTML = html;
    }

    // ====== Asignaciones: empleados y distritos ======
    async function cargarEmpleadosAsignar() {
      try {
        const resp = await fetch('php/asignaciones.php?accion=empleados', { cache: 'no-store' });
        const data = await resp.json();
        const sel = document.getElementById('selEmpleadoAsignar');
        if (!sel) return;
        sel.innerHTML = '<option value="">Seleccione empleado...</option>' +
          (data.datos || []).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
      } catch (e) { console.error('cargarEmpleadosAsignar', e); }
    }

    async function cargarDistritosAsignar() {
      try {
        const resp = await fetch('php/asignaciones.php?accion=distritos', { cache: 'no-store' });
        const data = await resp.json();
        const sel = document.getElementById('selDistritosAsignar');
        if (!sel) return;
        sel.innerHTML = (data.datos || []).map(d => `<option value="${d}">${d}</option>`).join('');
      } catch (e) { console.error('cargarDistritosAsignar', e); }
    }

    async function asignarPaquetesPorDistrito() {
      try {
        const selEmp = document.getElementById('selEmpleadoAsignar');
        const selDis = document.getElementById('selDistritosAsignar');
        const resBox = document.getElementById('resultadoAsignacion');
        const empleado_id = parseInt(selEmp?.value || '0', 10);
        const distritos = Array.from(selDis?.selectedOptions || []).map(o => o.value);
        if (!empleado_id) { alert('Seleccione un empleado'); return; }
        if (!distritos.length) { alert('Seleccione al menos un distrito'); return; }
        const form = new FormData();
        form.append('accion', 'asignar_por_distrito');
        form.append('empleado_id', String(empleado_id));
        distritos.forEach(d => form.append('distritos[]', d));
        const resp = await fetch('php/asignaciones.php', { method:'POST', body: form });
        const data = await resp.json();
        if (!data.exito) { alert('Error: ' + (data.mensaje || 'No se pudo asignar')); return; }
        resBox.textContent = `Asignados: ${data.asignados || 0}`;
      } catch (e) {
        console.error('asignarPaquetesPorDistrito', e);
        alert('Error al asignar: ' + e.message);
      }
    }
  </script>

  <script src="js/dashboard.js"></script>
</body>
</html>
